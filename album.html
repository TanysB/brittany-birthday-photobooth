<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Photo Album - Brittany's 22nd Birthday</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #F5DEB3, #DEB887);
            min-height: 100vh;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .album-container {
            position: relative;
            width: 100%;
            max-width: 280px;
            background-image: url('album.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            aspect-ratio: 1/2.5;
            margin-bottom: 25px;
        }

        /* Photo overlays positioned exactly in the white rectangles of album.png */
        .photo-overlay {
            position: absolute;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.1); /* Slight background for debugging */
        }

        /* Top photo - positioned in first white rectangle */
        .photo-1 {
            top: 2.5%;
            left: 8.9%;
            width: 82%;
            height: 24%;
        }

        /* Middle photo - positioned in second white rectangle */
        .photo-2 {
            top: 28.5%;
            left: 8.9%;
            width: 82%;
            height: 24%;
        }

        /* Bottom photo - positioned in third white rectangle */
        .photo-3 {
            top: 54.5%;
            left: 8.9%;
            width: 82.2%;
            height: 24%;
        }

        .album-photo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .photo-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #F5DEB3, #DEB887);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #654321;
            font-size: 0.8em;
            text-align: center;
            padding: 5px;
            line-height: 1.2;
            border: 1px dashed #654321;
        }

        .buttons-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .action-button {
            background: linear-gradient(135deg, #228B22, #006400);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            font-family: 'Georgia', serif;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .action-button:hover {
            background: linear-gradient(135deg, #32CD32, #228B22);
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
        }

        .action-button:active {
            transform: translateY(0);
        }

        .action-button.secondary {
            background: linear-gradient(135deg, #4169E1, #1E3A8A);
        }

        .action-button.secondary:hover {
            background: linear-gradient(135deg, #6495ED, #4169E1);
        }

        .action-button.danger {
            background: linear-gradient(135deg, #DC143C, #8B0000);
        }

        .action-button.danger:hover {
            background: linear-gradient(135deg, #FF1493, #DC143C);
        }

        .status-message {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px 25px;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: bold;
            display: none;
        }

        .status-success {
            background: rgba(76, 175, 80, 0.9);
            color: white;
            border: 2px solid #4CAF50;
        }

        .status-error {
            background: rgba(244, 67, 54, 0.9);
            color: white;
            border: 2px solid #f44336;
        }

        .status-warning {
            background: rgba(255, 193, 7, 0.9);
            color: #654321;
            border: 2px solid #FFC107;
        }

        .debug-info {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.8em;
            margin-top: 10px;
            max-width: 600px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            white-space: pre-wrap;
        }

        .session-info {
            background: rgba(101, 67, 33, 0.9);
            color: #F5DEB3;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 0.9em;
            margin-bottom: 15px;
            text-align: center;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .album-container {
                max-width: 250px;
            }
            
            .action-button {
                padding: 12px 25px;
                font-size: 1em;
            }
        }

        @media (max-width: 480px) {
            .album-container {
                max-width: 220px;
            }
        }
    </style>
</head>
<body>
    <div class="status-message" id="statusMessage"></div>

    <div class="session-info" id="sessionInfo">
        Loading session...
    </div>

    <div class="album-container" id="albumContainer">
        <div class="photo-overlay photo-1" id="photoSlot1">
            <div class="photo-placeholder">Loading Photo 1...</div>
        </div>
        <div class="photo-overlay photo-2" id="photoSlot2">
            <div class="photo-placeholder">Loading Photo 2...</div>
        </div>
        <div class="photo-overlay photo-3" id="photoSlot3">
            <div class="photo-placeholder">Loading Photo 3...</div>
        </div>
    </div>

    <div class="buttons-container">
        <button class="action-button" onclick="downloadAlbum()">
            üì• Download Album
        </button>
        <button class="action-button secondary" onclick="toggleDebug()">
            üîç Debug
        </button>
        <button class="action-button danger" onclick="clearAllSessions()">
            üóëÔ∏è Clear All
        </button>
    </div>

    <div class="debug-info" id="debugInfo"></div>

    <script>
        let photoData = [];
        let debugMode = false;
        let currentSessionId = null;

        // Debug logging with timestamp
        function debugLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const fullMessage = `[${timestamp}] ${message}`;
            console.log(fullMessage, data || '');
            
            if (debugMode) {
                const debugDiv = document.getElementById('debugInfo');
                debugDiv.textContent += fullMessage + '\n';
                if (data) {
                    debugDiv.textContent += `  Data: ${JSON.stringify(data, null, 2)}\n`;
                }
                debugDiv.scrollTop = debugDiv.scrollHeight;
            }
        }

        function toggleDebug() {
            debugMode = !debugMode;
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.style.display = debugMode ? 'block' : 'none';
            if (debugMode) {
                debugDiv.textContent = '=== DEBUG MODE ENABLED ===\n';
                debugLog('Debug mode activated');
                loadPhotos(); // Reload with debug
            }
        }

        function clearAllSessions() {
            if (confirm('Clear all photo sessions? This cannot be undone!')) {
                try {
                    // Clear localStorage
                    const localKeys = Object.keys(localStorage);
                    const sessionKeys = localKeys.filter(key => key.startsWith('session_'));
                    sessionKeys.forEach(key => {
                        localStorage.removeItem(key);
                        debugLog(`Removed localStorage key: ${key}`);
                    });

                    // Clear sessionStorage
                    const sessionKeys2 = Object.keys(sessionStorage);
                    const sessionKeys3 = sessionKeys2.filter(key => key.startsWith('session_'));
                    sessionKeys3.forEach(key => {
                        sessionStorage.removeItem(key);
                        debugLog(`Removed sessionStorage key: ${key}`);
                    });

                    showStatus('üóëÔ∏è All sessions cleared!', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } catch (error) {
                    debugLog('Error clearing sessions', error);
                    showStatus('‚ùå Error clearing sessions', 'error');
                }
            }
        }

        // COMPLETELY REWRITTEN: Get photos from specific session
        function loadPhotos() {
            debugLog('üîç Starting NEW photo loading process...');
            
            // First, get the session ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session');
            
            currentSessionId = sessionId;
            debugLog(`üéØ Target session ID: ${sessionId}`);
            
            // Update session info display
            const sessionInfo = document.getElementById('sessionInfo');
            if (sessionId) {
                sessionInfo.textContent = `Session: ${sessionId.slice(-12)}`;
            } else {
                sessionInfo.textContent = 'No session specified - searching for recent photos';
            }

            if (!sessionId) {
                debugLog('‚ùå No session ID in URL - looking for any recent photos');
                return loadMostRecentSession();
            }

            // Try to find this EXACT session
            debugLog(`üîç Looking for EXACT session: ${sessionId}`);
            
            // Check localStorage first
            let sessionData = null;
            try {
                sessionData = localStorage.getItem(sessionId);
                debugLog(`üìÇ localStorage lookup for ${sessionId}:`, sessionData ? 'FOUND' : 'NOT FOUND');
                
                if (sessionData) {
                    const parsed = JSON.parse(sessionData);
                    debugLog(`üìã Found session data in localStorage:`, {
                        hasPhotos: !!parsed.photos,
                        photoCount: parsed.photos ? parsed.photos.length : 0,
                        filter: parsed.filter,
                        timestamp: new Date(parsed.timestamp).toLocaleString(),
                        sessionId: parsed.sessionId
                    });
                    
                    if (parsed.photos && parsed.photos.length > 0) {
                        photoData = parsed.photos;
                        displayPhotos(sessionId);
                        showStatus(`‚úÖ Loaded ${parsed.photos.length} photos from session!`, 'success');
                        return true;
                    }
                }
            } catch (e) {
                debugLog('‚ùå localStorage error:', e.message);
            }

            // Check sessionStorage if not found in localStorage
            try {
                sessionData = sessionStorage.getItem(sessionId);
                debugLog(`üìÇ sessionStorage lookup for ${sessionId}:`, sessionData ? 'FOUND' : 'NOT FOUND');
                
                if (sessionData) {
                    const parsed = JSON.parse(sessionData);
                    debugLog(`üìã Found session data in sessionStorage:`, {
                        hasPhotos: !!parsed.photos,
                        photoCount: parsed.photos ? parsed.photos.length : 0,
                        filter: parsed.filter,
                        timestamp: new Date(parsed.timestamp).toLocaleString(),
                        sessionId: parsed.sessionId
                    });
                    
                    if (parsed.photos && parsed.photos.length > 0) {
                        photoData = parsed.photos;
                        displayPhotos(sessionId);
                        showStatus(`‚úÖ Loaded ${parsed.photos.length} photos from session!`, 'success');
                        return true;
                    }
                }
            } catch (e) {
                debugLog('‚ùå sessionStorage error:', e.message);
            }

            // Session not found anywhere
            debugLog(`‚ùå Session ${sessionId} NOT FOUND in any storage`);
            
            // Show what sessions ARE available
            debugStorageContents();
            
            showStatus(`‚ùå Session ${sessionId.slice(-8)} not found`, 'error');
            displayPlaceholders();
            return false;
        }

        // Debug: Show what's actually in storage
        function debugStorageContents() {
            debugLog('üîç === STORAGE CONTENTS DEBUG ===');
            
            try {
                const localKeys = Object.keys(localStorage);
                const sessionKeysLocal = localKeys.filter(key => key.startsWith('session_'));
                debugLog(`üìÇ localStorage has ${sessionKeysLocal.length} session keys:`, sessionKeysLocal);
                
                sessionKeysLocal.forEach(key => {
                    try {
                        const data = localStorage.getItem(key);
                        const parsed = JSON.parse(data);
                        debugLog(`  - ${key}: ${parsed.photos ? parsed.photos.length : 0} photos, ${new Date(parsed.timestamp).toLocaleString()}`);
                    } catch (e) {
                        debugLog(`  - ${key}: PARSE ERROR`);
                    }
                });
                
                const sessionKeysSession = Object.keys(sessionStorage).filter(key => key.startsWith('session_'));
                debugLog(`üìÇ sessionStorage has ${sessionKeysSession.length} session keys:`, sessionKeysSession);
                
                sessionKeysSession.forEach(key => {
                    try {
                        const data = sessionStorage.getItem(key);
                        const parsed = JSON.parse(data);
                        debugLog(`  - ${key}: ${parsed.photos ? parsed.photos.length : 0} photos, ${new Date(parsed.timestamp).toLocaleString()}`);
                    } catch (e) {
                        debugLog(`  - ${key}: PARSE ERROR`);
                    }
                });
                
            } catch (error) {
                debugLog('‚ùå Error debugging storage contents:', error.message);
            }
        }

        // Fallback: Load most recent session if no specific session found
        function loadMostRecentSession() {
            debugLog('üîÑ Looking for most recent session...');
            
            let allSessions = [];
            
            // Collect from localStorage
            try {
                const localKeys = Object.keys(localStorage);
                const sessionKeys = localKeys.filter(key => key.startsWith('session_'));
                
                sessionKeys.forEach(key => {
                    try {
                        const data = localStorage.getItem(key);
                        const parsed = JSON.parse(data);
                        if (parsed.photos && parsed.photos.length > 0) {
                            allSessions.push({
                                key: key,
                                data: parsed,
                                timestamp: parsed.timestamp || 0,
                                storage: 'localStorage'
                            });
                        }
                    } catch (e) {
                        debugLog(`Error parsing localStorage session ${key}:`, e.message);
                    }
                });
            } catch (e) {
                debugLog('Error reading localStorage:', e.message);
            }

            // Collect from sessionStorage
            try {
                const sessionKeys = Object.keys(sessionStorage).filter(key => key.startsWith('session_'));
                
                sessionKeys.forEach(key => {
                    try {
                        const data = sessionStorage.getItem(key);
                        const parsed = JSON.parse(data);
                        if (parsed.photos && parsed.photos.length > 0) {
                            allSessions.push({
                                key: key,
                                data: parsed,
                                timestamp: parsed.timestamp || 0,
                                storage: 'sessionStorage'
                            });
                        }
                    } catch (e) {
                        debugLog(`Error parsing sessionStorage session ${key}:`, e.message);
                    }
                });
            } catch (e) {
                debugLog('Error reading sessionStorage:', e.message);
            }

            debugLog(`üìä Found ${allSessions.length} valid sessions total`);

            if (allSessions.length === 0) {
                debugLog('‚ùå No valid sessions found anywhere');
                showStatus('‚ö†Ô∏è No photos found - showing sample album', 'warning');
                displayPlaceholders();
                return false;
            }

            // Sort by timestamp (newest first)
            allSessions.sort((a, b) => b.timestamp - a.timestamp);
            
            const mostRecent = allSessions[0];
            debugLog(`‚úÖ Using most recent session:`, {
                key: mostRecent.key,
                photoCount: mostRecent.data.photos.length,
                timestamp: new Date(mostRecent.timestamp).toLocaleString(),
                storage: mostRecent.storage
            });

            photoData = mostRecent.data.photos;
            displayPhotos(mostRecent.key);
            showStatus(`‚úÖ Loaded ${mostRecent.data.photos.length} photos from recent session`, 'success');
            return true;
        }

        // Display photos with session context
        function displayPhotos(sessionId) {
            debugLog(`üì∏ Displaying photos for session: ${sessionId}`);
            
            for (let i = 0; i < 3; i++) {
                const slot = document.getElementById(`photoSlot${i + 1}`);
                
                if (photoData[i]) {
                    debugLog(`üì∑ Creating image element for photo ${i + 1}`);
                    const img = document.createElement('img');
                    img.className = 'album-photo';
                    img.alt = `Photo ${i + 1}`;
                    img.src = photoData[i];
                    
                    // Add load handlers
                    img.onload = () => {
                        debugLog(`‚úÖ Photo ${i + 1} loaded successfully`);
                    };
                    img.onerror = () => {
                        debugLog(`‚ùå Photo ${i + 1} failed to load`);
                        slot.innerHTML = `<div class="photo-placeholder">Photo ${i + 1}<br>Load Error</div>`;
                    };
                    
                    slot.innerHTML = '';
                    slot.appendChild(img);
                } else {
                    debugLog(`üìù No data for photo ${i + 1}, showing placeholder`);
                    slot.innerHTML = `<div class="photo-placeholder">Photo ${i + 1}<br>Not Available</div>`;
                }
            }
        }

        // Create placeholder images when no photos are found
        function displayPlaceholders() {
            debugLog('üìù Displaying placeholder images...');
            
            for (let i = 0; i < 3; i++) {
                const slot = document.getElementById(`photoSlot${i + 1}`);
                const placeholder = createPlaceholder(i + 1);
                
                const img = document.createElement('img');
                img.className = 'album-photo';
                img.alt = `Placeholder ${i + 1}`;
                img.src = placeholder;
                
                slot.innerHTML = '';
                slot.appendChild(img);
            }
        }

        // Create placeholder image
        function createPlaceholder(index) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 300;
            
            // Background
            const gradient = ctx.createLinearGradient(0, 0, 400, 300);
            gradient.addColorStop(0, '#F5DEB3');
            gradient.addColorStop(1, '#DEB887');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 400, 300);
            
            // Text
            ctx.fillStyle = '#654321';
            ctx.font = 'bold 36px Georgia';
            ctx.textAlign = 'center';
            ctx.fillText(`Photo ${index}`, 200, 120);
            ctx.font = '20px Georgia';
            ctx.fillText("Brittany's 22nd Birthday", 200, 160);
            ctx.fillText('ü§† Western Theme üåµ', 200, 190);
            
            return canvas.toDataURL();
        }

        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Download the album as an image using html2canvas
        async function downloadAlbum() {
            debugLog('üíæ Starting album download...');
            
            try {
                const albumContainer = document.getElementById('albumContainer');
                
                // Use html2canvas if available
                if (typeof html2canvas !== 'undefined') {
                    debugLog('‚úÖ Using html2canvas for capture');
                    const canvas = await html2canvas(albumContainer, {
                        allowTaint: true,
                        useCORS: true,
                        scale: 2,
                        backgroundColor: null,
                        logging: debugMode
                    });
                    
                    // Download the image
                    const filename = currentSessionId ? 
                        `Brittany_Album_${currentSessionId.slice(-8)}.png` : 
                        'Brittany_22nd_Birthday_Album.png';
                    
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = canvas.toDataURL('image/png');
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showStatus('üì• Album downloaded successfully!', 'success');
                    debugLog('‚úÖ Album download completed');
                } else {
                    debugLog('‚ö†Ô∏è html2canvas not available');
                    showStatus('‚ùå Download not available (html2canvas missing)', 'error');
                }
                
            } catch (error) {
                debugLog('‚ùå Download failed:', error.message);
                showStatus('‚ùå Download failed. Please try again.', 'error');
            }
        }

        // Initialize page
        window.addEventListener('load', () => {
            debugLog('üéâ Album page loaded - initializing...');
            loadPhotos();
        });
    </script>
    
    <!-- html2canvas for download functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</body>
</html>
