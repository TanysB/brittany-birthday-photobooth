<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brittany's 22nd Birthday - Photo Gallery</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #F5DEB3, #DEB887, #CD853F);
            min-height: 100vh;
            padding: 20px;
        }

        .gallery-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(245, 222, 179, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            border: 4px solid #654321;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #654321;
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            font-style: italic;
        }

        .session-info {
            background: #654321;
            color: #F5DEB3;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .photo-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
            border: 3px solid #DEB887;
        }

        .photo-card img {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .photo-number {
            font-size: 1.1em;
            color: #654321;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .download-btn {
            background: linear-gradient(135deg, #8B4513, #654321);
            color: #F5DEB3;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1em;
            font-family: 'Georgia', serif;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            margin: 5px;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .download-btn:active {
            transform: translateY(0);
        }

        .download-all {
            text-align: center;
            margin: 30px 0;
        }

        .download-all .download-btn {
            font-size: 1.2em;
            padding: 15px 35px;
            background: linear-gradient(135deg, #CD853F, #8B4513);
        }

        .error-message {
            background: #8B0000;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .success-message {
            background: #228B22;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 10px 0;
            display: none;
        }

        .back-link {
            text-align: center;
            margin-top: 30px;
        }

        .back-link a {
            color: #654321;
            text-decoration: none;
            font-size: 1.1em;
            padding: 10px 20px;
            border: 2px solid #654321;
            border-radius: 25px;
            transition: all 0.3s ease;
        }

        .back-link a:hover {
            background: #654321;
            color: #F5DEB3;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #654321;
            font-size: 1.2em;
        }

        .debug-info {
            background: #f0f0f0;
            color: #333;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .gallery-container {
                padding: 20px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .photos-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="gallery-container">
        <div class="header">
            <h1>ü§† Photo Gallery üì∏</h1>
            <p>Brittany's 22nd Birthday Photo Booth</p>
        </div>

        <div id="loadingMessage" class="loading">
            üîÑ Loading your photos...
        </div>

        <div id="debugInfo" class="debug-info" style="display: none;">
            <strong>üîç Debug Information:</strong><br>
            <div id="debugDetails"></div>
        </div>

        <div id="sessionInfo" class="session-info" style="display: none;">
            <strong>üìÖ Session Info:</strong>
            <div id="sessionDetails"></div>
        </div>

        <div id="successMessage" class="success-message">
            ‚úÖ Download started!
        </div>

        <div id="photosContainer" class="photos-grid" style="display: none;">
            <!-- Photos will be inserted here -->
        </div>

        <div id="downloadAllContainer" class="download-all" style="display: none;">
            <button class="download-btn" onclick="downloadAllPhotos()">
                üì¶ Download All Photos
            </button>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;">
            ‚ùå Photos not found. The session may have expired or the QR code is invalid.
        </div>

        <div class="back-link">
            <a href="javascript:history.back()">‚Üê Back to Photo Booth</a>
        </div>
    </div>

    <script>
        let sessionPhotos = [];
        let sessionData = null;

        // Get session ID from URL
        function getSessionId() {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session');
            console.log('üîç Session ID from URL:', sessionId);
            return sessionId;
        }

        // Show debug information
        function showDebugInfo(sessionId) {
            const debugDiv = document.getElementById('debugInfo');
            const debugDetails = document.getElementById('debugDetails');
            
            // Get all localStorage keys
            const allKeys = Object.keys(localStorage);
            const sessionKeys = allKeys.filter(key => key.startsWith('session_'));
            
            debugDetails.innerHTML = `
                <strong>URL Session ID:</strong> ${sessionId || 'null'}<br>
                <strong>Current URL:</strong> ${window.location.href}<br>
                <strong>Available Sessions:</strong> ${sessionKeys.length}<br>
                ${sessionKeys.map(key => {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        return `‚Ä¢ ${key}: ${data.photos ? data.photos.length : 0} photos (${data.date || 'no date'})`;
                    } catch (e) {
                        return `‚Ä¢ ${key}: invalid data`;
                    }
                }).join('<br>')}
            `;
            
            debugDiv.style.display = 'block';
        }

        // Load photos from localStorage
        function loadPhotos() {
            const sessionId = getSessionId();
            console.log('üîç Loading session:', sessionId);

            // Always show debug info for troubleshooting
            showDebugInfo(sessionId);

            if (!sessionId) {
                showError('No session ID provided in URL. Make sure you scanned the QR code correctly.');
                return;
            }

            try {
                console.log('üîç Looking for data with key:', sessionId);
                const storedData = localStorage.getItem(sessionId);
                
                if (!storedData) {
                    console.error('‚ùå No data found for session:', sessionId);
                    
                    // Try to find similar sessions (in case of timing issues)
                    const allKeys = Object.keys(localStorage);
                    const sessionKeys = allKeys.filter(key => key.startsWith('session_'));
                    console.log('üìã Available sessions:', sessionKeys);
                    
                    if (sessionKeys.length > 0) {
                        // Try the most recent session as fallback
                        const mostRecent = sessionKeys.sort().pop();
                        console.log('üîÑ Trying most recent session:', mostRecent);
                        const fallbackData = localStorage.getItem(mostRecent);
                        
                        if (fallbackData) {
                            sessionData = JSON.parse(fallbackData);
                            sessionPhotos = sessionData.photos || [];
                            console.log(`‚úÖ Fallback successful: Found ${sessionPhotos.length} photos`);
                            displayPhotos();
                            showSessionInfo();
                            return;
                        }
                    }
                    
                    showError(`Session not found: ${sessionId}. Available sessions: ${sessionKeys.length}`);
                    return;
                }

                sessionData = JSON.parse(storedData);
                sessionPhotos = sessionData.photos || [];

                console.log(`‚úÖ Found ${sessionPhotos.length} photos in session`);
                console.log('üì∏ Session data:', sessionData);

                if (sessionPhotos.length === 0) {
                    showError('No photos found in this session');
                    return;
                }

                displayPhotos();
                showSessionInfo();

            } catch (error) {
                console.error('‚ùå Error loading photos:', error);
                showError('Error loading photos: ' + error.message);
            }
        }

        // Display session info
        function showSessionInfo() {
            if (sessionData) {
                const sessionInfo = document.getElementById('sessionInfo');
                const sessionDetails = document.getElementById('sessionDetails');
                
                sessionDetails.innerHTML = `
                    üì∏ ${sessionPhotos.length} photos ‚Ä¢ 
                    üé® Filter: ${sessionData.filter || 'none'} ‚Ä¢ 
                    üìÖ ${sessionData.date || 'Unknown date'}
                `;
                
                sessionInfo.style.display = 'block';
            }
        }

        // Display photos in grid
        function displayPhotos() {
            const container = document.getElementById('photosContainer');
            const downloadAllContainer = document.getElementById('downloadAllContainer');
            const loadingMessage = document.getElementById('loadingMessage');

            loadingMessage.style.display = 'none';
            container.style.display = 'grid';
            downloadAllContainer.style.display = 'block';

            container.innerHTML = '';

            sessionPhotos.forEach((photoData, index) => {
                if (photoData) {
                    const photoCard = document.createElement('div');
                    photoCard.className = 'photo-card';
                    
                    photoCard.innerHTML = `
                        <div class="photo-number">Photo ${index + 1}</div>
                        <img src="${photoData}" alt="Photo ${index + 1}" id="photo${index}">
                        <button class="download-btn" onclick="downloadPhoto(${index})">
                            üíæ Download Photo ${index + 1}
                        </button>
                    `;
                    
                    container.appendChild(photoCard);
                }
            });

            console.log('‚úÖ Photos displayed successfully');
        }

        // Download individual photo
        function downloadPhoto(index) {
            try {
                const photoData = sessionPhotos[index];
                if (!photoData) {
                    alert('Photo not found');
                    return;
                }

                const link = document.createElement('a');
                link.download = `Brittany_Birthday_Photo_${index + 1}.png`;
                link.href = photoData;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showSuccess();
                console.log(`üì• Photo ${index + 1} downloaded`);

            } catch (error) {
                console.error('‚ùå Download error:', error);
                alert('Download failed: ' + error.message);
            }
        }

        // Download all photos as individual files
        function downloadAllPhotos() {
            try {
                sessionPhotos.forEach((photoData, index) => {
                    if (photoData) {
                        setTimeout(() => {
                            downloadPhoto(index);
                        }, index * 500); // Stagger downloads by 500ms
                    }
                });

                showSuccess();
                console.log('üì• All photos download started');

            } catch (error) {
                console.error('‚ùå Download all error:', error);
                alert('Download failed: ' + error.message);
            }
        }

        // Show error message
        function showError(message) {
            console.error('‚ùå', message);
            
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('photosContainer').style.display = 'none';
            document.getElementById('downloadAllContainer').style.display = 'none';
            
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = `‚ùå ${message}`;
            errorDiv.style.display = 'block';
        }

        // Show success message
        function showSuccess() {
            const successDiv = document.getElementById('successMessage');
            successDiv.style.display = 'block';
            
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // Initialize when page loads
        window.addEventListener('load', () => {
            console.log('üéâ Gallery page loaded');
            console.log('üîó Current URL:', window.location.href);
            loadPhotos();
        });
    </script>
</body>
</html>
