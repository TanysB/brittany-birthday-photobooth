<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brittany's 22nd Birthday - Photo Gallery</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #F5DEB3, #DEB887);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .gallery-container {
            position: relative;
            width: 100%;
            max-width: 350px;
            background-image: url('album.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            aspect-ratio: 1/2.5;
            margin-bottom: 30px;
        }

        /* Photo overlays positioned exactly in the white rectangles of album.png */
        .photo-overlay {
            position: absolute;
            overflow: hidden;
        }

        /* Top photo - positioned in first white rectangle */
        .photo-1 {
            top: 2.5%;
            left: 8.9%;
            width: 82%;
            height: 24%;
        }

        /* Middle photo - positioned in second white rectangle */
        .photo-2 {
            top: 28.5%;
            left: 8.9%;
            width: 82%;
            height: 24%;
        }

        /* Bottom photo - positioned in third white rectangle */
        .photo-3 {
            top: 54.5%;
            left: 8.9%;
            width: 82.2%;
            height: 24%;
        }

        .gallery-photo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* Save button - classy cursive design */
        .save-button {
            background: linear-gradient(135deg, #654321, #4a2c1a, #3e2415);
            color: #d4b896;
            border: none;
            padding: 20px 45px;
            border-radius: 50px;
            font-size: 1.4em;
            font-weight: normal;
            font-family: 'Brush Script MT', cursive, 'Georgia', serif;
            font-style: italic;
            cursor: pointer;
            box-shadow: 
                0 8px 25px rgba(52, 36, 21, 0.5),
                0 4px 12px rgba(0, 0, 0, 0.4),
                inset 0 2px 0 rgba(212, 184, 150, 0.2);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6);
            position: relative;
            overflow: hidden;
            border: 2px solid #8B4513;
            letter-spacing: 2px;
            min-width: 280px;
            backdrop-filter: blur(10px);
        }

        .save-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 184, 150, 0.3), transparent);
            transition: left 0.7s;
        }

        .save-button:hover {
            background: linear-gradient(135deg, #7d5436, #5a3422, #4a2c1a);
            transform: translateY(-3px) scale(1.03);
            box-shadow: 
                0 12px 35px rgba(52, 36, 21, 0.6),
                0 8px 20px rgba(0, 0, 0, 0.5),
                inset 0 2px 0 rgba(212, 184, 150, 0.3);
            color: #e6d4b8;
        }

        .save-button:hover::before {
            left: 100%;
        }

        .save-button:active {
            transform: translateY(-1px) scale(1.01);
            box-shadow: 
                0 6px 20px rgba(52, 36, 21, 0.5),
                0 3px 10px rgba(0, 0, 0, 0.4);
        }

        .button-text {
            position: relative;
            z-index: 2;
        }

        /* Loading message */
        .loading-message {
            text-align: center;
            margin-bottom: 30px;
            color: #654321;
            font-size: 1.3em;
            font-style: italic;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            background: rgba(255, 255, 255, 0.8);
            padding: 20px 30px;
            border-radius: 25px;
            border: 3px solid #654321;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        /* Error message */
        .error-message {
            text-align: center;
            margin-bottom: 30px;
            color: #8B0000;
            font-size: 1.2em;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px 30px;
            border-radius: 25px;
            border: 3px solid #8B0000;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            display: none;
        }

        /* Debug info */
        .debug-info {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #654321;
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            color: #333;
            display: none;
        }

        /* Success message */
        .success-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #32CD32, #228B22, #006400);
            color: white;
            padding: 25px 45px;
            border-radius: 25px;
            font-size: 1.4em;
            font-weight: bold;
            box-shadow: 
                0 15px 40px rgba(0, 0, 0, 0.4),
                0 8px 20px rgba(50, 205, 50, 0.3);
            z-index: 1000;
            display: none;
            text-align: center;
            border: 3px solid white;
            backdrop-filter: blur(10px);
            animation: successPulse 0.6s ease-out;
        }

        @keyframes successPulse {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .gallery-container {
                max-width: 320px;
            }
            
            .save-button {
                padding: 18px 40px;
                font-size: 1.3em;
                min-width: 260px;
            }
            
            .loading-message {
                font-size: 1.2em;
                padding: 18px 25px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .gallery-container {
                max-width: 300px;
            }
            
            .save-button {
                padding: 16px 35px;
                font-size: 1.2em;
                min-width: 240px;
            }
            
            .loading-message {
                font-size: 1.1em;
                padding: 15px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-message" id="loadingMessage">
        Loading your amazing photos...
    </div>

    <div class="error-message" id="errorMessage">
        <!-- Error messages will appear here -->
    </div>

    <div class="debug-info" id="debugInfo">
        <!-- Debug information will appear here -->
    </div>

    <div class="gallery-container" id="galleryContainer" style="display: none;">
        <!-- Photo overlays positioned exactly in the white rectangles -->
        <div class="photo-overlay photo-1" id="photoSlot1">
            <!-- Photo 1 will be inserted here -->
        </div>
        <div class="photo-overlay photo-2" id="photoSlot2">
            <!-- Photo 2 will be inserted here -->
        </div>
        <div class="photo-overlay photo-3" id="photoSlot3">
            <!-- Photo 3 will be inserted here -->
        </div>
    </div>
    
    <!-- Save to Gallery Button -->
    <button class="save-button" onclick="saveToGallery()" id="saveButton" style="display: none;">
        <span class="button-text">Save to Gallery</span>
    </button>

    <!-- Success message -->
    <div class="success-message" id="successMessage">
        Photos saved successfully!<br>
        <small style="font-size: 0.8em; margin-top: 8px; display: block;">Check your downloads folder!</small>
    </div>

    <script>
        let photoData = [];
        let sessionData = null;

        // Enhanced logging function
        function log(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            // Show debug info in UI for troubleshooting
            const debugDiv = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            debugDiv.style.display = 'block';
        }

        // Get photo data from URL parameters or localStorage
        function getPhotoData() {
            log('Starting photo data retrieval...');
            
            // Get session ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session');
            
            log(`Session ID from URL: ${sessionId}`);
            log(`Current URL: ${window.location.href}`);
            
            // First, try the exact session ID from URL
            if (sessionId) {
                try {
                    log(`Looking for session data with key: ${sessionId}`);
                    const storedData = localStorage.getItem(sessionId);
                    
                    if (storedData) {
                        sessionData = JSON.parse(storedData);
                        photoData = sessionData.photos || [];
                        log(`‚úÖ Found ${photoData.length} photos in session ${sessionId}`);
                        return true;
                    } else {
                        log(`‚ùå No data found for session ${sessionId}`, 'error');
                    }
                } catch (e) {
                    log(`‚ùå Error parsing session data: ${e.message}`, 'error');
                }
            }
            
            // Show what's available in localStorage for debugging
            const allKeys = Object.keys(localStorage);
            const sessionKeys = allKeys.filter(key => key.startsWith('session_'));
            log(`üìã Available sessions in localStorage: [${sessionKeys.join(', ')}]`);
            
            // If exact session not found but others exist, try fallback
            if (sessionKeys.length > 0) {
                log('üîÑ Trying most recent session as fallback...');
                
                // Sort sessions by timestamp (newest first)
                const sortedSessions = sessionKeys.sort((a, b) => {
                    const timeA = a.split('_')[1] || '0';
                    const timeB = b.split('_')[1] || '0';
                    return parseInt(timeB) - parseInt(timeA);
                });
                
                const mostRecent = sortedSessions[0];
                log(`üîÑ Trying fallback session: ${mostRecent}`);
                
                try {
                    const fallbackData = localStorage.getItem(mostRecent);
                    if (fallbackData) {
                        sessionData = JSON.parse(fallbackData);
                        photoData = sessionData.photos || [];
                        log(`‚úÖ Fallback successful: Found ${photoData.length} photos in ${mostRecent}`);
                        log(`‚ö†Ô∏è Note: Using fallback session instead of requested ${sessionId}`);
                        return true;
                    }
                } catch (e) {
                    log(`‚ùå Fallback failed: ${e.message}`, 'error');
                }
            }

            // Fallback: try to get from URL parameters (old method)
            const photoParam = urlParams.get('photos');
            if (photoParam) {
                try {
                    photoData = JSON.parse(decodeURIComponent(photoParam));
                    log(`‚úÖ Loaded ${photoData.length} photos from URL parameters`);
                    return true;
                } catch (e) {
                    log(`‚ùå Could not parse URL photo data: ${e.message}`, 'error');
                }
            }

            log(`‚ùå No photo data found anywhere`);
            return false;
        }

        // Generate placeholder photos for testing
        function generatePlaceholderPhotos() {
            log('Generating placeholder photos...');
            const placeholders = [];
            for (let i = 0; i < 3; i++) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 400;
                canvas.height = 300;
                
                // Create a gradient background
                const gradient = ctx.createLinearGradient(0, 0, 400, 300);
                gradient.addColorStop(0, '#F5DEB3');
                gradient.addColorStop(1, '#DEB887');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 400, 300);
                
                // Add text
                ctx.fillStyle = '#654321';
                ctx.font = 'bold 48px Georgia';
                ctx.textAlign = 'center';
                ctx.fillText(`Photo ${i + 1}`, 200, 120);
                ctx.font = '24px Georgia';
                ctx.fillText("Brittany's 22nd BDAY", 200, 160);
                ctx.fillText('ü§† Mexican Western üåµ', 200, 200);
                
                placeholders.push(canvas.toDataURL('image/png'));
            }
            return placeholders;
        }

        // Show error message
        function showError(message) {
            log(`Showing error: ${message}`, 'error');
            
            const loadingMsg = document.getElementById('loadingMessage');
            const errorMsg = document.getElementById('errorMessage');
            const galleryContainer = document.getElementById('galleryContainer');
            const saveButton = document.getElementById('saveButton');
            
            loadingMsg.style.display = 'none';
            galleryContainer.style.display = 'none';
            saveButton.style.display = 'none';
            
            errorMsg.innerHTML = `
                <strong>‚ùå Could not load photos</strong><br>
                ${message}<br><br>
                <small>Check the debug information below for details.</small>
            `;
            errorMsg.style.display = 'block';
        }

        // Display photos in the gallery
        function displayPhotos() {
            log('Displaying photos...');
            
            if (!photoData || photoData.length === 0) {
                showError('No photos found in this session.');
                return;
            }

            // Ensure we have exactly 3 photos (pad with placeholders if needed)
            while (photoData.length < 3) {
                photoData.push(null);
            }

            let photosLoaded = 0;
            
            photoData.slice(0, 3).forEach((photo, index) => {
                const photoSlot = document.getElementById(`photoSlot${index + 1}`);
                if (photoSlot) {
                    photoSlot.innerHTML = ''; // Clear any existing content
                    
                    if (photo) {
                        const img = document.createElement('img');
                        img.src = photo;
                        img.className = 'gallery-photo';
                        img.alt = `Photo ${index + 1}`;
                        
                        img.onload = () => {
                            photosLoaded++;
                            log(`Photo ${index + 1} loaded successfully`);
                            
                            if (photosLoaded === photoData.filter(p => p).length) {
                                log('All photos loaded successfully');
                                showGallery();
                            }
                        };
                        
                        img.onerror = () => {
                            log(`Failed to load photo ${index + 1}`, 'error');
                            // Create placeholder for failed photo
                            const placeholderCanvas = document.createElement('canvas');
                            const ctx = placeholderCanvas.getContext('2d');
                            placeholderCanvas.width = 400;
                            placeholderCanvas.height = 300;
                            ctx.fillStyle = '#f0f0f0';
                            ctx.fillRect(0, 0, 400, 300);
                            ctx.fillStyle = '#999';
                            ctx.font = '20px Georgia';
                            ctx.textAlign = 'center';
                            ctx.fillText('Photo unavailable', 200, 150);
                            
                            img.src = placeholderCanvas.toDataURL();
                        };
                        
                        photoSlot.appendChild(img);
                    } else {
                        // Create placeholder for missing photo
                        log(`Creating placeholder for missing photo ${index + 1}`);
                        const placeholderCanvas = document.createElement('canvas');
                        const ctx = placeholderCanvas.getContext('2d');
                        placeholderCanvas.width = 400;
                        placeholderCanvas.height = 300;
                        
                        const gradient = ctx.createLinearGradient(0, 0, 400, 300);
                        gradient.addColorStop(0, '#F5DEB3');
                        gradient.addColorStop(1, '#DEB887');
                        ctx.fillStyle = gradient;
                        ctx.fillRect(0, 0, 400, 300);
                        
                        ctx.fillStyle = '#654321';
                        ctx.font = '24px Georgia';
                        ctx.textAlign = 'center';
                        ctx.fillText('No Photo', 200, 150);
                        
                        const img = document.createElement('img');
                        img.src = placeholderCanvas.toDataURL();
                        img.className = 'gallery-photo';
                        img.alt = `Photo ${index + 1} (placeholder)`;
                        photoSlot.appendChild(img);
                        
                        photosLoaded++;
                    }
                }
            });

            // If no actual photos, show gallery immediately
            if (photoData.filter(p => p).length === 0) {
                showGallery();
            }
        }

        // Show the gallery and hide loading
        function showGallery() {
            log('Showing gallery interface');
            
            const loadingMsg = document.getElementById('loadingMessage');
            const galleryContainer = document.getElementById('galleryContainer');
            const saveButton = document.getElementById('saveButton');
            
            loadingMsg.style.display = 'none';
            galleryContainer.style.display = 'block';
            saveButton.style.display = 'block';
        }

        // Save photos to device gallery - captures the exact display
        async function saveToGallery() {
            log('Save to gallery clicked');
            
            // Add visual feedback that processing is happening
            const saveButton = document.querySelector('.save-button');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<span class="button-text">Processing...</span>';
            saveButton.disabled = true;
            
            try {
                // Capture the gallery as it appears on screen
                await captureGalleryDisplay();

                // Show success message
                showSuccessMessage();

            } catch (error) {
                log(`Error saving photos: ${error.message}`, 'error');
                alert('Sorry, there was an error saving your photos. Please try again.');
            } finally {
                // Restore button
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            }
        }

        // Capture the gallery exactly as displayed with album background and positioned photos
        async function captureGalleryDisplay() {
            log('Starting gallery capture...');
            
            const galleryContainer = document.getElementById('galleryContainer');
            const containerRect = galleryContainer.getBoundingClientRect();
            
            // Create a canvas with the same dimensions as the gallery container
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size to match the gallery container (reduced scale to prevent freezing)
            const scale = 2; // Reduced from 3 to prevent performance issues
            canvas.width = containerRect.width * scale;
            canvas.height = containerRect.height * scale;
            ctx.scale(scale, scale);
            
            try {
                log('Loading album background...');
                // Load and draw the actual album.png background
                const albumBackground = await createAlbumBackground(containerRect.width, containerRect.height);
                ctx.drawImage(albumBackground, 0, 0, containerRect.width, containerRect.height);
                log('Album background loaded successfully');
                
                // Draw each captured photo sequ
