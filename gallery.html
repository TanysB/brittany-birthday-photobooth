<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brittany's 22nd Birthday - Photo Gallery</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #F5DEB3, #DEB887);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .gallery-container {
            position: relative;
            width: 100%;
            max-width: 350px;
            background-image: url('album.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            aspect-ratio: 1/2.5;
            margin-bottom: 30px;
        }

        /* Photo overlays positioned exactly in the white rectangles of album.png */
        .photo-overlay {
            position: absolute;
            overflow: hidden;
        }

        /* Top photo - positioned in first white rectangle */
        .photo-1 {
            top: 2.5%;
            left: 8.9%;
            width: 82%;
            height: 24%;
        }

        /* Middle photo - positioned in second white rectangle */
        .photo-2 {
            top: 28.5%;
            left: 8.9%;
            width: 82%;
            height: 24%;
        }

        /* Bottom photo - positioned in third white rectangle */
        .photo-3 {
            top: 54.5%;
            left: 8.9%;
            width: 82.2%;
            height: 24%;
        }

        .gallery-photo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* Save button */
        .save-button {
            background: linear-gradient(135deg, #654321, #4a2c1a, #3e2415);
            color: #d4b896;
            border: none;
            padding: 20px 45px;
            border-radius: 50px;
            font-size: 1.4em;
            font-weight: normal;
            font-family: 'Brush Script MT', cursive, 'Georgia', serif;
            font-style: italic;
            cursor: pointer;
            box-shadow: 
                0 8px 25px rgba(52, 36, 21, 0.5),
                0 4px 12px rgba(0, 0, 0, 0.4),
                inset 0 2px 0 rgba(212, 184, 150, 0.2);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6);
            position: relative;
            overflow: hidden;
            border: 2px solid #8B4513;
            letter-spacing: 2px;
            min-width: 280px;
        }

        .save-button:hover {
            background: linear-gradient(135deg, #7d5436, #5a3422, #4a2c1a);
            transform: translateY(-3px) scale(1.03);
            box-shadow: 
                0 12px 35px rgba(52, 36, 21, 0.6),
                0 8px 20px rgba(0, 0, 0, 0.5),
                inset 0 2px 0 rgba(212, 184, 150, 0.3);
            color: #e6d4b8;
        }

        /* Status message */
        .status-message {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px 25px;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            max-width: 400px;
        }

        .status-success {
            background: rgba(76, 175, 80, 0.9);
            color: white;
            border: 2px solid #4CAF50;
        }

        .status-error {
            background: rgba(244, 67, 54, 0.9);
            color: white;
            border: 2px solid #f44336;
        }

        .status-info {
            background: rgba(33, 150, 243, 0.9);
            color: white;
            border: 2px solid #2196F3;
        }

        /* Debug info */
        .debug-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            z-index: 9999;
            display: none;
        }

        .debug-toggle {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: #333;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            font-size: 16px;
            z-index: 9998;
            width: 50px;
            height: 50px;
        }

        /* Success message */
        .success-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #32CD32, #228B22);
            color: white;
            padding: 25px 45px;
            border-radius: 25px;
            font-size: 1.4em;
            font-weight: bold;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none;
            text-align: center;
            border: 3px solid white;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            body { padding: 15px; }
            .gallery-container { max-width: 320px; }
            .save-button { 
                padding: 18px 40px;
                font-size: 1.3em;
                min-width: 260px;
            }
        }
    </style>
</head>
<body>
    <!-- Status Message -->
    <div id="statusMessage" class="status-message status-info">
        üì± Loading photos...
    </div>

    <!-- Gallery Container -->
    <div class="gallery-container" id="galleryContainer">
        <div class="photo-overlay photo-1" id="photoSlot1"></div>
        <div class="photo-overlay photo-2" id="photoSlot2"></div>
        <div class="photo-overlay photo-3" id="photoSlot3"></div>
    </div>
    
    <!-- Save Button -->
    <button class="save-button" onclick="saveToGallery()" id="saveButton">
        <span class="button-text">Save to Gallery</span>
    </button>

    <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel"></div>
    <button class="debug-toggle" onclick="toggleDebug()">üêõ</button>

    <!-- Success Popup -->
    <div class="success-popup" id="successPopup">
        Photos saved successfully!<br>
        <small style="font-size: 0.8em;">Check your downloads folder!</small>
    </div>

    <script>
        let photoData = [];
        let debugMessages = [];

        function debugLog(message, type = 'info') {
            console.log(`[${type}] ${message}`);
            debugMessages.push(`[${new Date().toLocaleTimeString()}] ${message}`);
            if (debugMessages.length > 20) debugMessages = debugMessages.slice(-20);
            updateDebugPanel();
        }

        function updateDebugPanel() {
            const panel = document.getElementById('debugPanel');
            panel.innerHTML = debugMessages.join('<br>');
        }

        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
        }

        // Get photos from multiple sources (URL, localStorage, sessionStorage)
        function getPhotosFromURL() {
            debugLog('üîç Checking multiple sources for photo data...');
            
            const urlParams = new URLSearchParams(window.location.search);
            
            // METHOD 1: Check for photo ID (short URL approach)
            const photoId = urlParams.get('id');
            if (photoId) {
                debugLog(`üìã Found photo ID: ${photoId}`);
                
                // Try localStorage first
                try {
                    const localData = localStorage.getItem(photoId);
                    if (localData) {
                        const parsed = JSON.parse(localData);
                        if (parsed.photos && parsed.photos.length > 0) {
                            debugLog(`‚úÖ Found ${parsed.photos.length} photos in localStorage`);
                            photoData = parsed.photos;
                            return true;
                        }
                    }
                } catch (e) {
                    debugLog('‚ùå localStorage failed');
                }
                
                // Try sessionStorage
                try {
                    const sessionData = sessionStorage.getItem(photoId);
                    if (sessionData) {
                        const parsed = JSON.parse(sessionData);
                        if (parsed.photos && parsed.photos.length > 0) {
                            debugLog(`‚úÖ Found ${parsed.photos.length} photos in sessionStorage`);
                            photoData = parsed.photos;
                            return true;
                        }
                    }
                } catch (e) {
                    debugLog('‚ùå sessionStorage failed');
                }
                
                debugLog('‚ùå Photo ID found but no matching data in storage');
            }
            
            // METHOD 2: Check for tiny photos in URL
            const tinyPhotos = urlParams.get('tiny');
            if (tinyPhotos) {
                debugLog('üì∏ Found tiny photos in URL');
                try {
                    const decoded = atob(tinyPhotos);
                    const tinyData = JSON.parse(decoded);
                    
                    if (tinyData.photos && tinyData.photos.length > 0) {
                        debugLog(`‚úÖ Found ${tinyData.photos.length} tiny photos in URL`);
                        photoData = tinyData.photos;
                        return true;
                    }
                } catch (error) {
                    debugLog(`‚ùå Error decoding tiny photos: ${error.message}`);
                }
            }
            
            // METHOD 3: Check for full photos in URL (original method)
            const photosParam = urlParams.get('photos');
            if (photosParam) {
                debugLog('üì∏ Found photos parameter in URL');
                try {
                    const decoded = atob(photosParam);
                    const photoArray = JSON.parse(decoded);
                    
                    if (photoArray.photos && photoArray.photos.length > 0) {
                        debugLog(`‚úÖ Found ${photoArray.photos.length} full photos in URL`);
                        photoData = photoArray.photos;
                        return true;
                    }
                } catch (error) {
                    debugLog(`‚ùå Error decoding photos: ${error.message}`);
                }
            }
            
            // METHOD 4: Check for any photos in browser storage (fallback)
            debugLog('üîÑ Searching all browser storage for photos...');
            
            // Check localStorage
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('photos_')) {
                        const data = localStorage.getItem(key);
                        if (data) {
                            const parsed = JSON.parse(data);
                            if (parsed.photos && parsed.photos.length > 0) {
                                debugLog(`‚úÖ Found fallback photos in localStorage: ${key}`);
                                photoData = parsed.photos;
                                return true;
                            }
                        }
                    }
                }
            } catch (e) {
                debugLog('‚ùå localStorage search failed');
            }
            
            // Check sessionStorage
            try {
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    if (key && key.startsWith('photos_')) {
                        const data = sessionStorage.getItem(key);
                        if (data) {
                            const parsed = JSON.parse(data);
                            if (parsed.photos && parsed.photos.length > 0) {
                                debugLog(`‚úÖ Found fallback photos in sessionStorage: ${key}`);
                                photoData = parsed.photos;
                                return true;
                            }
                        }
                    }
                }
            } catch (e) {
                debugLog('‚ùå sessionStorage search failed');
            }
            
            debugLog('‚ùå No photos found in any source');
            return false;
        }

        // Create placeholder image
        function createPlaceholder(index) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 300;
            
            // Background
            const gradient = ctx.createLinearGradient(0, 0, 400, 300);
            gradient.addColorStop(0, '#F5DEB3');
            gradient.addColorStop(1, '#DEB887');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 400, 300);
            
            // Text
            ctx.fillStyle = '#654321';
            ctx.font = 'bold 36px Georgia';
            ctx.textAlign = 'center';
            ctx.fillText(`Photo ${index}`, 200, 120);
            ctx.font = '20px Georgia';
            ctx.fillText("Brittany's 22nd Birthday", 200, 160);
            ctx.fillText('ü§† Western Theme üåµ', 200, 190);
            
            // Debug info
            ctx.font = '14px monospace';
            ctx.fillText('No URL photo data found', 200, 230);
            ctx.fillText('Check QR code generation', 200, 250);
            
            return canvas.toDataURL();
        }

        // Display photos
        function displayPhotos() {
            debugLog('üì∏ Starting photo display...');
            
            const hasPhotos = getPhotosFromURL();
            
            if (hasPhotos && photoData.length > 0) {
                updateStatus(`‚úÖ Displaying ${photoData.length} photos`, 'success');
                debugLog(`‚úÖ Displaying ${photoData.length} real photos`);
                
                // Show green border briefly
                document.body.style.border = '5px solid green';
                setTimeout(() => document.body.style.border = 'none', 2000);
                
                // Display each photo
                for (let i = 0; i < 3; i++) {
                    const slot = document.getElementById(`photoSlot${i + 1}`);
                    const img = document.createElement('img');
                    img.className = 'gallery-photo';
                    img.alt = `Photo ${i + 1}`;
                    
                    if (photoData[i]) {
                        img.src = photoData[i];
                        debugLog(`üì∑ Loaded photo ${i + 1} from URL data`);
                    } else {
                        img.src = createPlaceholder(i + 1);
                        debugLog(`üìù Created placeholder for slot ${i + 1}`);
                    }
                    
                    slot.innerHTML = '';
                    slot.appendChild(img);
                }
                
            } else {
                updateStatus('‚ùå No photos found - showing placeholders', 'error');
                debugLog('‚ùå No photos found, showing placeholders');
                
                // Show red border briefly
                document.body.style.border = '5px solid red';
                setTimeout(() => document.body.style.border = 'none', 2000);
                
                // Show placeholders
                for (let i = 0; i < 3; i++) {
                    const slot = document.getElementById(`photoSlot${i + 1}`);
                    const img = document.createElement('img');
                    img.className = 'gallery-photo';
                    img.src = createPlaceholder(i + 1);
                    img.alt = `Placeholder ${i + 1}`;
                    
                    slot.innerHTML = '';
                    slot.appendChild(img);
                }
            }
        }

        // Save photos to device
        async function saveToGallery() {
            debugLog('üíæ Save button clicked');
            
            if (photoData.length === 0) {
                alert('No photos to save!');
                return;
            }

            const button = document.getElementById('saveButton');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="button-text">Saving...</span>';
            button.disabled = true;

            try {
                // Create a ZIP-like approach or download each photo
                for (let i = 0; i < photoData.length; i++) {
                    const link = document.createElement('a');
                    link.download = `Brittany_Birthday_Photo_${i + 1}.jpg`;
                    link.href = photoData[i];
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Small delay between downloads
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                // Show success message
                const popup = document.getElementById('successPopup');
                popup.style.display = 'block';
                setTimeout(() => popup.style.display = 'none', 3000);
                
                debugLog('‚úÖ All photos saved successfully');

            } catch (error) {
                debugLog(`‚ùå Save error: ${error.message}`);
                alert('Error saving photos. Please try again.');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            debugLog('üéâ Gallery page loaded');
            debugLog(`üìç Current URL: ${window.location.href}`);
            
            const urlParams = new URLSearchParams(window.location.search);
            debugLog(`üìã URL parameters: ${Array.from(urlParams.entries()).map(([k,v]) => `${k}=${v.substring(0,50)}...`).join(', ')}`);
            
            displayPhotos();
        });
    </script>
</body>
</html>
