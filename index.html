// REPLACE your generateQRCodeWithPhotosInURL function with this:

function generateQRCodeWithPhotosInURL() {
    console.log('=== GENERATING URL-BASED QR CODE ===');
    
    const qrContainer = document.getElementById('qrcode');
    if (!qrContainer) {
        console.error('‚ùå QR container not found!');
        return;
    }
    
    qrContainer.innerHTML = '<div style="color: white; padding: 10px; font-size: 0.8em; text-align: center;">üîÑ Creating shareable link...</div>';
    
    try {
        const validPhotos = capturedPhotos.filter(photo => photo !== null);
        console.log(`üì∏ Valid photos count: ${validPhotos.length}`);
        
        if (validPhotos.length === 0) {
            qrContainer.innerHTML = '<div style="color: white; padding: 10px; font-size: 0.8em; text-align: center;">‚ùå No photos to share</div>';
            return;
        }
        
        // Create URL with photos embedded as parameters
        const currentLocation = window.location;
        const baseUrl = `${currentLocation.protocol}//${currentLocation.host}${currentLocation.pathname.substring(0, currentLocation.pathname.lastIndexOf('/') + 1)}album.html`;
        
        const urlParams = new URLSearchParams();
        let processedPhotos = 0;
        
        // Process each photo
        validPhotos.forEach((photo, index) => {
            if (photo) {
                // Create a temporary canvas to compress the photo
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Make photos much smaller for URL transmission
                    const maxSize = 150; // Very small for QR code
                    let { width, height } = this;
                    
                    // Calculate new dimensions
                    if (width > height) {
                        if (width > maxSize) {
                            height = (height * maxSize) / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = (width * maxSize) / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(this, 0, 0, width, height);
                    
                    // Ultra-high compression for URL
                    const compressedPhoto = canvas.toDataURL('image/jpeg', 0.2);
                    urlParams.set(`p${index + 1}`, encodeURIComponent(compressedPhoto));
                    
                    processedPhotos++;
                    
                    // Check if all photos are processed
                    if (processedPhotos === validPhotos.length) {
                        finishQRGeneration();
                    }
                };
                
                img.src = photo;
            } else {
                processedPhotos++;
                if (processedPhotos === validPhotos.length) {
                    finishQRGeneration();
                }
            }
        });
        
        function finishQRGeneration() {
            // Add additional info
            urlParams.set('filter', currentFilter);
            urlParams.set('date', new Date().toISOString());
            
            const finalUrl = baseUrl + '?' + urlParams.toString();
            
            console.log(`üîó Shareable URL created (${finalUrl.length} chars)`);
            
            // Check URL length (QR codes have practical limits)
            if (finalUrl.length > 2800) {
                console.warn('‚ö†Ô∏è URL might be too long for QR code');
                qrContainer.innerHTML = `
                    <div style="color: white; padding: 8px; font-size: 0.7em; text-align: center; line-height: 1.4;">
                        <strong>‚ö†Ô∏è Photos too large</strong><br>
                        Try retaking with better lighting<br>
                        <small>${finalUrl.length} chars (max ~2800)</small>
                    </div>
                `;
                return;
            }
            
            // Generate QR code
            try {
                if (typeof qrcode === 'undefined') {
                    throw new Error('QR code library not loaded');
                }
                
                const qr = qrcode(0, 'L'); // Low error correction for more data capacity
                qr.addData(finalUrl);
                qr.make();
                
                const qrImage = qr.createImgTag(4, 0); // Smaller size for mobile scanning
                qrContainer.innerHTML = qrImage;
                
                console.log('‚úÖ URL-BASED QR CODE GENERATED SUCCESSFULLY!');
                
                // Add success indicator
                setTimeout(() => {
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = 'position: absolute; top: 5px; right: 5px; background: green; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.6em; z-index: 1000;';
                    successDiv.textContent = 'üì± MOBILE';
                    qrContainer.style.position = 'relative';
                    qrContainer.appendChild(successDiv);
                    
                    setTimeout(() => successDiv.remove(), 3000);
                }, 100);
                
                // Update subtitle
                const subtitle = document.getElementById('qrSubtitle');
                if (subtitle) {
                    subtitle.textContent = 'Scan with your phone to view & save!';
                }
                
                console.log('üì± Mobile-friendly QR generation complete');
                
            } catch (qrError) {
                console.error('‚ùå QR generation failed:', qrError);
                qrContainer.innerHTML = `
                    <div style="color: white; padding: 8px; font-size: 0.7em; text-align: center; line-height: 1.4;">
                        <strong>‚ùå QR Error</strong><br>
                        ${qrError.message}<br>
                        <small>URL: ${finalUrl.length} chars</small>
                    </div>
                `;
            }
        }
        
    } catch (error) {
        console.error('‚ùå URL generation completely failed:', error);
        qrContainer.innerHTML = `
            <div style="color: white; padding: 8px; font-size: 0.8em; text-align: center;">
                <div style="background: red; color: white; padding: 2px 6px; border-radius: 3px; margin-bottom: 6px;">‚ùå ERROR</div>
                <small>Check browser console</small>
            </div>
        `;
    }
}
